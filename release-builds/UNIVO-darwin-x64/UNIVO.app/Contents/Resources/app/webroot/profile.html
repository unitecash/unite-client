<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNIVO</title>
<link rel="shortcut icon" href="./res/icon.png" />
<link rel="stylesheet" type="text/css" href="./css/style.css" />
<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
<script src="./js/jquery.js"></script>
<script src="./js/bitcoincash.min.js"></script>
<script src="./js/sha512.js"></script>
<script src="./js/socket.io.js"></script>
<script src="./js/pnglib.js"></script>
<script src="./js/identicon.js"></script>
<script src="./js/bchaddr.js"></script>
<script src="./js/init.js"></script>
<script>
var load_data = function(){
	// hide hidden components
	$('#changeNameDiv').hide();
	$('#moreProfileInfo').hide();
	$('#mybalance').on('click', function(){
		display_html_alert('#moreProfileInfo');
	});
	$('#changename').on('click', function(){
		display_html_alert('#changeNameDiv');
	});
	
	// name change form submit listener
	$('#namechangesubmit').on('click', function(){
		var name = $('#newName').val();
		if(name.length <= 4 || name.length > 24){
			display_alert("Your name shouldn't be less than 5 or more than 24 characters!");
		}else{
			find_utxo(address.toString()).then(function(utxo){
				// create dummy tx to find approx size with fee
				transaction = new bch.Transaction();
				transaction.from(utxo);
				transaction.to(address.toString(), utxo.satoshis - 768); // approximate
				transaction.to(centralAddress, 547)
				transaction.addData(hex2a('5504')+name)
				transaction.sign(privateKey);
				var tx_size = parseInt(transaction.toString().length/2);
				// recreate transaction with correct fee
				transaction = new bch.Transaction();
				transaction.from(utxo)
				transaction.to(address.toString(), utxo.satoshis - 547 - tx_size)
				transaction.to(centralAddress, 547)
				transaction.addData(hex2a('5504')+name)
				transaction.sign(privateKey);
				broadcast_tx(transaction.toString());
				display_success('Name updated!');
				$('#newName').val('');
			});
		}
	});
	
	// set address text
	$('#myaddress').text(bchaddr.toCashAddress(address.toString()));
	
	// get address balance
	// TODO get_balance(addr)
	$.ajax({
		type: "GET",
		url: insightBaseURL + 'addr/' + address.toString(),
		success: function(data){
			$('#mybalance').text('BALANCE: ' + data.balance + " BCH");
		}
	});
	
	// get posts this user has written in the past
	get_transactions(address.toString()).then(function(tx_arr){
		for(var i = 0; i < tx_arr.length; i++){
			parse_tx(tx_arr[i], 0);
		}
	});
	
	// get the user's name and display italic
	get_name(address.toString()).then(function(name){
		$('#myName').text('Hi, ' + name.name + '!');
	});
	
	// display a QR code for deposit
	$('#myqrcode').attr('src', 'https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=' + bchaddr.toCashAddress(address.toString()));
	
	// set the private key text
	$('#privateKeyText').text(privateKey.toWIF());
}
var handle_new_post = function(post){
	// Only display posts sent by this user
	if(post.sender == address.toString()){
		render_post(post.name, post.time, post.data, post.isLive);
	}
}
</script>
<script>if (window.module) module = window.module;</script>
</head>
<body>
<div class="nav">
<div class="heading">
<img src="./res/icon.png" id="headericon" />
<h1 id="headertitle">Profile</h1>
</div>
<div class="navlinks">
<a class="navlink" href="newposts.html"><img src="./res/newposts_icon.svg" /><span>New Posts</span></a>
<a class="navlink" href="newusers.html"><img src="./res/newusers_icon.svg" /><span>New Users</span></a>
<a class="navlink" href="feed.html"><img src="./res/feed_icon.svg" /><span>Feed</span></a>
<a class="navlink" href="popular.html"><img src="./res/popular_icon.svg" /><span>Popular</span></a>
<a class="navlink" href="profile.html"><img src="./res/profile_icon.svg" /><span>Profile</span></a>
</div>
</div>
<div class="content">
<center>
<!--- TODO profile photo --->
<p id="myName"></p>
<button class="UIButton" id="changename">CHANGE NAME</button>
<button class="UIButton" id="mybalance"></button>
<div id="changeNameDiv" class="UIAlertWindow">
<h3>Change Name</h3>
<p>Note that your name is <b style="color:red;">NOT</b> the username that you use to unlock your account. Your name
is what others see when you post. Unless you set it here, your name will show up as the first
6 characters of your Bitcoin Cash address.</p>
<input type="text" id="newName" class="UITextField" placeholder="New name..." /><br/><br/>
<button class="UIButton" id="namechangesubmit">CHANGE NAME</button>
</div>
<div id="moreProfileInfo" class="UIAlertWindow">
<p>Your Address:</p>
<p class="UIPanel" style="font-family:monospace;" id="myaddress"></p>
<img class="qrcode" id="myqrcode" alt="QR Code" /><br/><br/>
<button class="UIButton" style="color:red;" onclick="display_html_alert('#showKey')">SHOW PRIVATE KEY</button>
</div>
<div style="display:none;" id="showKey" class="UIAlertWindow">
<h1>YOUR PRIVATE KEY</h1>
<p>Never share your key with anyone. With this key, somebody will be able to <span style="color:red;">
hack your account and steal your money.</span> To show your key, click the button below.
<span style="color:red;"> Only do this if you know exactly what you are doing and understand the risks!</span></p>
<button class="UIButton" style="color:red;" onclick="display_html_alert('#showPrivateKey')">I UNDERSTAND</button>
</div>
<div style="display:none;" id="showPrivateKey" class="UIAlertWindow">
<p>YOUR PRIVATE KEY:</p>
<p id="privateKeyText" class="UIPanel" style="color:red; font-family:monospace;font-weight:bold;"></p>
</div>
</center>
<form id="sendpost">
<p>Write a Post</p>
<center>
<textarea class="UITextArea" id="newpost"></textarea>
</center>
<input type="submit" id="sendbutton" class="UIButton" value="SEND" />
</form>
<h1>Your Posts</h1>
<div id="posts"></div>
</div>
</body>
</html>
